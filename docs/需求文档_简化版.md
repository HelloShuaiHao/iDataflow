# iDataflow 产品需求文档（简化版）

## 一、产品定位

**单租户数据流配置平台** - 每个部署服务一家公司，部署50次到不同服务器。

### 核心理念
- 1 个部署 = 1 家公司
- 用户直接使用 n8n 可视化界面创建工作流
- 后台提供监控、用户管理、数据接收功能

---

## 二、系统架构

```
┌─────────────────────────────────────────────────┐
│  单个部署实例（重复50次到不同服务器）             │
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │  管理后台 (Web UI)                    │      │
│  │  - 用户登录/管理                      │      │
│  │  - 工作流列表展示                     │      │
│  │  - 执行历史监控                       │      │
│  │  - WebSocket 数据接收状态             │      │
│  └────────────┬─────────────────────────┘      │
│               ↓                                 │
│  ┌──────────────────────────────────────┐      │
│  │  iDataflow Backend (API)              │      │
│  │  - 用户认证                           │      │
│  │  - n8n API 调用                       │      │
│  │  - WebSocket 服务                     │      │
│  └────────────┬─────────────────────────┘      │
│               ↓                                 │
│  ┌──────────────────────────────────────┐      │
│  │  n8n 工作流引擎                       │      │
│  │  用户直接访问 n8n 界面编辑工作流       │      │
│  └────────────┬─────────────────────────┘      │
│               ↓                                 │
│  ┌──────────────────────────────────────┐      │
│  │  PostgreSQL 数据库                    │      │
│  │  - 用户表                             │      │
│  │  - 工作流记录（同步自n8n）            │      │
│  │  - 执行历史                           │      │
│  └──────────────────────────────────────┘      │
└─────────────────────────────────────────────────┘
```

---

## 三、核心功能

### 3.1 用户管理
- [ ] 用户注册（管理员创建账号）
- [ ] 用户登录/登出（JWT）
- [ ] 角色：管理员、普通成员、只读用户
- [ ] 密码修改

### 3.2 工作流管理（只读展示）
- [ ] 显示所有工作流列表（从 n8n 同步）
- [ ] 查看工作流详情
- [ ] 查看工作流状态（激活/停用）
- [ ] 快捷跳转到 n8n 编辑界面

**重要：用户在 n8n 界面中创建和编辑工作流，后台只负责展示。**

### 3.3 执行监控
- [ ] 实时显示工作流执行状态
- [ ] 执行历史记录
- [ ] 执行失败告警
- [ ] 执行统计图表

### 3.4 数据接收（WebSocket）
- [ ] WebSocket 服务接收设备数据
- [ ] 数据自动触发对应工作流
- [ ] 连接状态监控
- [ ] 数据接收日志

### 3.5 系统设置
- [ ] n8n 连接配置
- [ ] WebSocket 端口配置
- [ ] 数据库备份
- [ ] 日志查看

---

## 四、数据库设计（简化版）

### users 表（用户管理）
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(20) DEFAULT 'member',  -- admin, member, viewer
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### workflows 表（同步自n8n）
```sql
CREATE TABLE workflows (
  id SERIAL PRIMARY KEY,
  n8n_workflow_id VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  active BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### executions 表（执行历史）
```sql
CREATE TABLE executions (
  id SERIAL PRIMARY KEY,
  workflow_id INTEGER REFERENCES workflows(id),
  n8n_execution_id VARCHAR(255),
  status VARCHAR(50),  -- success, failed, running
  started_at TIMESTAMP,
  finished_at TIMESTAMP,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### websocket_logs 表（WebSocket数据日志）
```sql
CREATE TABLE websocket_logs (
  id SERIAL PRIMARY KEY,
  client_id VARCHAR(255),
  message_type VARCHAR(50),
  payload JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**移除：** ❌ companies 表（不需要了）

---

## 五、页面结构

### 管理后台（Web UI）

```
/login                    - 登录页
/dashboard                - 仪表盘（概览）
  ├─ 工作流数量
  ├─ 今日执行次数
  ├─ 成功率
  └─ WebSocket 连接状态

/workflows                - 工作流列表
  ├─ 列表视图（同步自n8n）
  ├─ 状态显示（激活/停用）
  └─ [编辑按钮] → 跳转到 n8n

/executions               - 执行历史
  ├─ 时间线视图
  ├─ 筛选（工作流、状态、时间）
  └─ 详情查看

/websocket                - WebSocket 监控
  ├─ 连接列表
  ├─ 接收数据日志
  └─ 发送测试消息

/users                    - 用户管理（仅管理员）
  ├─ 用户列表
  ├─ 添加用户
  └─ 修改角色

/settings                 - 系统设置
  ├─ n8n 连接测试
  ├─ 备份/恢复
  └─ 日志下载
```

---

## 六、技术栈

### 后端
- **框架**: 使用C#编程就行
- **数据库**: PostgreSQL 15
- **认证**: JWT
- **WebSocket**: ws

### 前端（推荐）
- **框架**: React 18 + Vite
- **UI 库**: Ant Design / Material-UI
- **状态管理**: Zustand / Context API
- **HTTP 客户端**: Axios

### 工作流引擎
- **n8n**: 官方 Docker 镜像（用户直接使用原生界面）

### 部署
- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx（可选）
- **SSL**: Let's Encrypt

---

## 七、用户使用流程

### 工作流创建流程
```
1. 管理员登录后台
2. 点击 "打开 n8n 工作流编辑器"
3. 跳转到 n8n 界面 (http://your-domain.com:5678)
4. 在 n8n 中可视化创建/编辑工作流
5. 保存后，后台自动同步显示新工作流
```

### 数据接收流程
```
1. 设备通过 WebSocket 连接到后台
2. 发送数据: { type: "data", sensorId: "123", value: 25.5 }
3. 后台接收数据，记录日志
4. 触发对应的 n8n 工作流执行
5. n8n 处理数据（发送通知、存储等）
6. 后台记录执行历史
```

---

## 八、部署方式

### 单服务器部署（标准模式）

```bash
# 服务器 1 - 公司 A
git clone <repository-url>
cd iDataflow
cp .env.example .env
# 编辑 .env 配置公司信息
docker-compose up -d

# 访问
# http://company-a.com:3000  - 管理后台
# http://company-a.com:5678  - n8n 工作流编辑器
```

```bash
# 服务器 2 - 公司 B
# 重复上述步骤...
```

**每个公司的部署完全独立，互不影响。**

---

## 九、核心 API 接口

### 用户认证
```
POST /api/auth/login       - 登录
POST /api/auth/logout      - 登出
GET  /api/auth/me          - 获取当前用户信息
```

### 工作流（只读，从 n8n 同步）
```
GET  /api/workflows        - 获取所有工作流（从 n8n 同步）
GET  /api/workflows/:id    - 获取工作流详情
POST /api/workflows/sync   - 手动同步 n8n 工作流
```

### 执行历史
```
GET  /api/executions                    - 获取执行历史
GET  /api/executions/:id                - 获取执行详情
GET  /api/workflows/:id/executions      - 获取某个工作流的执行历史
```

### WebSocket 监控
```
GET  /api/websocket/stats              - 获取连接统计
GET  /api/websocket/logs               - 获取数据日志
POST /api/websocket/test               - 发送测试消息
```

### 系统
```
GET  /api/system/health                - 健康检查
GET  /api/system/n8n-status            - n8n 连接状态
POST /api/system/backup                - 备份数据库
```

---

## 十、开发计划

### MVP（最小可行版本）- 2-3 周

#### Week 1: 后端基础
- [x] Docker 环境搭建（已完成）
- [ ] 用户认证系统（JWT）
- [ ] n8n 工作流同步接口
- [ ] 执行历史记录
- [ ] WebSocket 服务

#### Week 2: 前端开发
- [ ] 登录页面
- [ ] 仪表盘
- [ ] 工作流列表页（显示 n8n 工作流）
- [ ] 执行历史页
- [ ] 用户管理页

#### Week 3: 集成测试
- [ ] n8n 集成测试
- [ ] WebSocket 测试
- [ ] 端到端测试
- [ ] 文档完善
- [ ] 部署脚本

### Phase 2: 增强功能 - 1-2 周
- [ ] 执行统计图表
- [ ] 失败告警（邮件/企业微信）
- [ ] 数据备份/恢复
- [ ] 日志管理
- [ ] 性能监控

### Phase 3: 生产优化
- [ ] Nginx 反向代理
- [ ] SSL 证书配置
- [ ] 性能优化
- [ ] 安全加固
- [ ] 监控告警

---

## 十一、关键问题澄清

### Q1: 用户在哪里创建工作流？
**A**: 用户直接访问 n8n 界面（http://your-domain.com:5678），使用 n8n 原生的可视化编辑器。

### Q2: 后台的作用是什么？
**A**:
- 用户登录认证
- 展示工作流列表（只读，同步自 n8n）
- 监控工作流执行
- 接收 WebSocket 数据
- 系统管理和统计

### Q3: 50 个公司怎么部署？
**A**: 在 50 台不同的服务器（或虚拟机）上各部署一次，每个部署完全独立。

### Q4: 需要开发可视化编辑器吗？
**A**: ❌ 不需要！用户直接使用 n8n 自带的编辑器。

### Q5: 如何隔离公司数据？
**A**: 物理隔离，每个公司独立部署，天然隔离。

---

## 十二、与原方案的对比

| 对比项 | 原方案（多租户） | 新方案（单租户） |
|--------|-----------------|-----------------|
| **架构** | 1 套系统服务 50 家公司 | 50 套独立系统 |
| **隔离方式** | 逻辑隔离（数据库） | 物理隔离（服务器） |
| **工作流编辑** | 需要自己开发 | 使用 n8n 原生界面 ✅ |
| **公司管理** | 需要复杂的后台 | 不需要 ✅ |
| **部署复杂度** | 一次部署 | 50 次部署 |
| **维护成本** | 低（统一维护） | 中（独立维护） |
| **资源消耗** | 低（共享资源） | 高（独立资源） |
| **扩展性** | 好（加公司容易） | 一般（加服务器） |
| **开发周期** | 8-12 周 | 2-3 周 ✅ |

---

## 十三、下一步行动

### 立即确认的问题
1. [ ] 确认每个公司是否有独立服务器/VPS？ 是的
2. [ ] 确认是否需要统一的"总控台"查看所有公司状态？ 不用
3. [ ] 确认用户量：每个公司预计多少用户？ 比较少
4. [ ] 确认数据量：每天预计多少次工作流执行？ 比较多 websocket推送

### 技术决策
1. [ ] 前端框架：React 还是 Vue？
2. [ ] UI 组件库：Ant Design 还是 Material-UI？
3. [ ] 是否需要移动端适配？
4. [ ] 是否需要国际化（中英文）？用英文

### 开始开发
确认以上问题后，可以立即开始 MVP 开发。

---

**这个方案简单、清晰、可快速实现！** 🚀

**核心优势：**
- ✅ 用户使用 n8n 原生界面（无需自己开发）
- ✅ 架构简单（物理隔离，无复杂逻辑）
- ✅ 开发周期短（2-3 周）
- ✅ 维护清晰（独立部署）
